## top 系列

### top

```
top - 14:12:45 up 5 days,  2:37,  1 user,  load average: 2.61, 2.67, 2.75
Tasks: 162 total,   1 running, 113 sleeping,   0 stopped,   0 zombie
%Cpu(s): 77.4 us, 13.3 sy,  0.0 ni,  8.2 id,  0.0 wa,  0.0 hi,  1.2 si,  0.0 st
KiB Mem : 15885328 total,   288312 free, 10698076 used,  4898940 buff/cache
KiB Swap:        0 total,        0 free,        0 used.  3313836 avail Mem

  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND
  950 hadoop    20   0 2351188 685528  26348 S  40.9  4.3  31:27.82 java
12287 hadoop    20   0 3099372   1.2g  28576 S  34.9  7.8   1015:00 java
 9989 hdfs      20   0 3852804   1.5g  25844 S  32.2  9.6 830:58.65 java
 8793 root      20   0  424768 194348   7148 S  25.6  1.2 594:31.71 python
```
load average 表示的是CPU的负载，包含的信息不是CPU的使用率状况，而是在一段时间内CPU正在处理以及等待CPU处理的进程数之和的统计信息，也就是CPU使用队列的长度的统计信息。

我们举个例子：高速公路收费站10个车道，那当有1-9辆车在不同的通道通过时，认为收费站的load<1;当正好10辆车在不同的通道时，load=1;当超过10辆车（假设每个通道是均匀有车）时，load>1.假设有100辆车，每个通道10辆，那就说明能有10辆车能过去，另外90辆车则需要等待。此时收费站的load为100/10=10. 这个10的负载表示系统当前满负荷运转，且还有相当于90%的满负载的请求在等待。

一般业界能够被接受的值是， load average <= CPU核数 \* 0.7。 但现在硬件越来越便宜，核数庞大的机器也越来越大，如遇到机器的CPU核数很大，那么剩余的30%部分也越大，这个时候可以适当的调整下，只要不要到整个核数都用满。


VIRT：virtual memory usage 虚拟内存

1. 进程“需要的”虚拟内存大小，包括进程使用的库、代码、数据等
2. 假如进程申请100m的内存，但实际只使用了10m，那么它会增长100m，而不是实际的使用量

RES：resident memory usage 常驻内存

1. 进程当前使用的内存大小，但不包括swap out
2. 包含其他进程的共享
3. 如果申请100m的内存，实际使用10m，它只增长10m，与VIRT相反
4. 关于库占用内存的情况，它只统计加载的库文件所占内存大小

SHR：shared memory 共享内存

1. 除了自身进程的共享内存，也包括其他进程的共享内存
2. 虽然进程只使用了几个共享库的函数，但它包含了整个共享库的大小
3. 计算某个进程所占的物理内存大小公式：RES – SHR
4. swap out后，它将会降下来


### atop

atop就是一款用于监控Linux系统资源与进程的工具，它以一定的频率记录系统的运行状态，所采集的数据包含系统CPU、内存、磁盘、网络的资源使用情况和进程运行情况，并能以日志文件的方式保存在磁盘中，服务器出现问题后，可获取相应的atop日志文件进行分析。


#### 安装

```shell 
# centos
yum install atop -y

# Ubuntu
apt-get install atop -y

#/etc/init.d/atop
service atop start

# atop配置文件，主要用于调整atop监控周期，默认600s采集一次数据
vi /etc/sysconfig/atop

# atop的定时任务文件
vi /etc/cron.d/atop
```

#### 常用指令

1. c：按照进程CPU使用率进行降序筛选。
1. m：按照进程内存使用率进行降序筛选。
1. d：按照进程磁盘使用率进行降序筛选。
1. a：按照进程资源综合使用率进行降序筛选。
1. n：按照进程网络使用率进行降序筛选，需要额外安装内核模块才支持，默认不支持。
1. t：跳转到下一个监控采集点。
1. T：跳转到上一个监控采集点。
1. B：指定时间点，格式为hh:mm:ss。

#### 监控字段含义

- ATOP列：显示了主机名、信息采样日期和时间点。
- PRC列：显示进程整体运行情况。
	+ sys、user字段：分别代表进程在内核态和用户态的运行时间。
	+ #proc字段：代表进程总数。
	+ #zombie字段：代表僵死进程的数量。
	+ #exit字段：代表atop采样周期期间退出的进程数量。
- CPU列：显示CPU整体的使用情况，即多核CPU作为一个整体CPU资源的使用情况，我们知道CPU可被用于执行进程、处理中断，也可处于空闲状态，空闲状态分两种，一种是活动进程等待磁盘IO导致CPU空闲，另一种是完全空闲。
	+ sys、user字段：CPU在用于处理进程时，进程在内核态、用户态所占CPU的时间比例。
	+ irq字段：CPU用于处理中断的时间比例。
	+ idle字段：CPU处在完全空闲状态的时间比例。
	+ wait字段：CPU处在“进程等待磁盘IO导致CPU空闲”状态的时间比例。
	+ 注：CPU列各个字段指示值相加结果为N00%，其中N为CPU的核数。 
- cpu列：显示某一核CPU的使用情况，各字段含义可参照CPU列，各字段值相加结果为100%。
- CPL列：显示CPU负载情况。
	+ avg1、avg5和avg15字段：分别代表过去1分钟、5分钟和15分钟内运行队列中的平均进程数量。
	+ csw字段：上下文切换次数。
	+ intr字段：中断发生次数。
- MEM列：代表内存的使用情况。
	+ tot字段：物理内存总量。
	+ free字段：空闲内存的大小。
	+ cache字段：用于页缓存的内存大小。
	+ buff字段：用于文件缓存的内存大小。
	+ slab字段：系统内核占用的内存大小。
- SWP列：显示交换空间的使用情况。
	+ tot字段：交换区总量。
	+ free字段：空闲交换空间大小。
- PAG列：显示虚拟内存分页情况。
	+ swin、swout字段：分别代表换入和换出内存页数。
- DSK列：显示磁盘使用情况，每一个磁盘设备对应一列，如果有vdb设备，那么增多一列DSK信息。
	+ vda字段：磁盘设备标识。
	+ busy字段：磁盘忙时比例。
	+ read、write字段：分别代表读、写请求数量。
- NET列：多列NET展示了网络状况，包括传输层TCP和UDP、IP层以及各活动的网口信息。
	+ XXXi字段：各层或活动网口收包数目。
	+ XXXo字段：各层或活动网口发包数目。


### htop
